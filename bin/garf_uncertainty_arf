#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import garf
import click
import SimpleITK as sitk
import numpy as np

# -----------------------------------------------------------------------------
CONTEXT_SETTINGS = dict(help_option_names=['-h', '--help'])
@click.command(context_settings=CONTEXT_SETTINGS)
@click.argument('image_mhd')
@click.argument('N')
@click.option('--output', '-o',
              help='If set, write uncertainty image.')
@click.option('--threshold', '-t',
              default=0.0,
              help='Threshold in %, do not consider pixel with value lower than this % of the max value')
# -----------------------------------------------------------------------------
def garf_uncertainty_arf(image_mhd, n, output, threshold):
    '''
    \b
    Compute uncertainty for ARF result (need squared image)

    IMAGE_MHD : ARF image from garf_build_arf_image_with_nn
    N         : nb of events used to build the image
    '''

    N = int(float(n))
    filename = image_mhd
    sq_filename = filename.replace(".mhd", "_squared.mhd")
    img = sitk.ReadImage(filename)
    sq_img = sitk.ReadImage(sq_filename)

    # get data in np
    data = sitk.GetArrayFromImage(img)#.astype(float)
    sq_data = sitk.GetArrayFromImage(sq_img)#.astype(float)
    n_ene_win = len(data)-1

    # scale to N (because data were divided by N events)
    data = data*N
    sq_data = sq_data*N*N

    uncert = np.copy(data)
    uncert.fill(0.0)

    dmax = np.max(data)
    threshold = threshold*dmax

    # loop
    sigma, uncert = garf.image_uncertainty_arf(data, sq_data, N, threshold)

    for i in range(len(sigma)):
        n = np.count_nonzero(uncert[i])
        print("Channel {0} uncertainty = {1:.2f} % nb pixels = {2}".format(i, sigma[i]*100.0, n))

    # output
    if output:
        img_uncert = sitk.GetImageFromArray(uncert)
        img_uncert.CopyInformation(img)
        img_uncert = sitk.Cast(img_uncert, sitk.sitkFloat32)
        sitk.WriteImage(img_uncert, output)


# -----------------------------------------------------------------------------
if __name__ == '__main__':
    garf_uncertainty_arf()
